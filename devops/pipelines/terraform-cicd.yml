trigger:
  - master

pr: none

resources:
  repositories:
    - repository: templates
      endpoint: "Bitbucket - carlosrv125"
      name: carlosrv125/dso-iac-template
      ref: refs/tags/v0.0.4
      type: bitbucket

variables:
  - group: terraform-sample-global
  - template: ../vars/vars-global.yaml

pool:
  vmImage: "ubuntu-22.04"

stages:
  - stage: DEV
    jobs:
      - job: "TerraformApply"
        variables:
          - template: ../vars/vars-dev.yaml
        steps:
          - template: templates/terraform/ci-cd/ci-cd.yaml@templates
            parameters:
              terraform_version: ${{ variables.terraform_version }}
              remote_backend_rg_name: ${{ variables.remote_backend_rg_name }}
              remote_backend_storage_account_name: ${{ variables.remote_backend_storage_account_name }}
              remote_backend_container_name: ${{ variables.remote_backend_container_name }}
              remote_backend_key: ${{ variables.remote_backend_key }}
              remote_backend_service_connection: ${{ variables.remote_backend_service_connection }}
              azurerm_account_service_connection: ${{ variables.azurerm_account_service_connection }}
              terraform_var_file_path: ${{ variables.terraform_var_file_path }}
              terraform_workspace_name: ${{ variables.terraform_workspace_name }}
              terraform_secrets:
                TF_VAR_db_password: $(db_password)
              terraform_token_artifactory: $(artifactory_token)
              terraform_token_cloud: $(terraform_token_cloud)

  - stage: UAT
    jobs:
      - job: "TerraformApply"
        variables:
          - template: ../vars/vars-uat.yaml
        steps:
          - template: templates/terraform/ci-cd/ci-cd.yaml@templates
            parameters:
              terraform_version: ${{ variables.terraform_version }}
              remote_backend_rg_name: ${{ variables.remote_backend_rg_name }}
              remote_backend_storage_account_name: ${{ variables.remote_backend_storage_account_name }}
              remote_backend_container_name: ${{ variables.remote_backend_container_name }}
              remote_backend_key: ${{ variables.remote_backend_key }}
              remote_backend_service_connection: ${{ variables.remote_backend_service_connection }}
              azurerm_account_service_connection: ${{ variables.azurerm_account_service_connection }}
              terraform_var_file_path: ${{ variables.terraform_var_file_path }}
              terraform_workspace_name: ${{ variables.terraform_workspace_name }}
              terraform_secrets:
                TF_VAR_db_password: $(db_password)
              terraform_token_artifactory: $(artifactory_token)
              terraform_token_cloud: $(terraform_token_cloud)
